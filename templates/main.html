{% extends "base.html" %}
{% from "macros/main.html" import listen_button, star_button, share_button, create_button, discussion_button, starrers_menu, context_to_string, person_thumb %} 

{% block head %}
<script>
  var fb_logged_in = false;
  window.fbAsyncInit = function() {
    FB.init({
      appId      : {{facebook_app_id|json}}, // App ID
      //channelUrl : '//WWW.YOUR_DOMAIN.COM/channel.html', // Channel File
      status     : true, // check login status
      cookie     : true, // enable cookies to allow the server to access the session
      xfbml      : true  // parse XFBML
    });
    FB.getLoginStatus(function(data){
        if (data.authResponse && data.authResponse.userID == fb_id) {
            fb_logged_in = true;
        }
    });
    // Additional initialization code here
  };

  // Load the SDK Asynchronously
  (function(d){
     var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement('script'); js.id = id; js.async = true;
     js.src = "//connect.facebook.net/en_US/all.js";
     ref.parentNode.insertBefore(js, ref);
   }(document));
</script>
{% endblock head %}
{% block body_classes %}{{ super() }} main {% endblock body_classes%}

{% block main %}
  <div id='nav_hive' class='nav'
    ><a href='{{ server_url }}'><div id='logo' class='hoverable icon left_edge'></div></a
    {% if user.logged_in %}
      ><div id='username' class='text center text_btn hoverable name'>{{ user.name|capitalize }}</div
    {% endif %}
    ><div id='create_btn' class='center hoverable right_edge'
      ><a href='{{ create }}' onclick='return require_login()'
        ><div class='text'>Create</div
        ><div id='create_icon' class='icon right_edge'></div
      ></a></div
  ></div>

  <div id='hive_menu' class='menu'>
    {% if user.logged_in %}
      <div id='hive_btns' class='btns'
        ><a href='{{ server_url }}'><div class='menu_item default'>My Network</div></a
        ><a href='{{ server_url }}/home/expressions'><div class='menu_item'>Featured</div></a
        ><a href='{{ server_url }}/home/people'><div class='menu_item'>People</div></a
      ></div>
    {% endif %}
    <a href='{{ server_url }}random'><div id='random_btn' class='icon hoverable rounded' title="View Random Expression"></div></a>
    <form method='GET' action='{{ server_url }}search' name='search_form'>
      <input type="text" id="search_box" placeholder="Search" name='q' value='{{ q.q|e }}' class='scale'/>
      <div class='hoverable icon scale submit' title='Submit search' onclick='document.forms.search_form.submit()'></div>
    </form>
  </div>
  <script>
    hover_menu( '#logo', '#hive_menu', { offset_y: 8, open: function(){
        $('#search_box').get(0).focus(); }, click_persist: '#search_box' } );
  </script>

  {% if user.logged_in %}
    <div id='user_menu' class='menu feed_menu'>
      <a href='{{ home_url }}'><div class='menu_item default'>Expressions</div></a>
      <div id='user_btns' class='btns'
        ><div class='menu_item'>Invite friends!</div
        ><div class='menu_item'>Settings</div
        ><form id='logout_form' action='{{ secure_server }}' method='POST'
          ><div onclick='$("#logout_form").submit()' class='menu_item'>Log out</div
          ><input name='action' value='logout' type='hidden'
          ><input name='url' value='{{ url }}' type='hidden'
        ></form
      ></div>
      <div class='bar'></div>
      <a href='{{ feed_url }}'><div class='menu_item'>Activity</div></a>
      <div id='user_activity_feed'>
        {% for feed in user.feed_profile(viewer=user, limit=7) %}
          {% include "partials/feed.html" %}
        {% endfor %}
      </div>
    </div>
    <script>hover_menu( '#username', '#user_menu', { offset_y: 8 } )</script>
  {% endif %}

  {% if not editing %}
    <div id='nav_content' class='nav'
      {% set nav_begin = True %}
      {% if not user.logged_in %}
        ><div class='center'><div id='login_btn' class='text center hoverable text_btn left_edge'>Log In</div></div
        {% set nav_begin = False %}
      {% endif %}
      {% if owner and not user_is_owner %}
        ><div id='owner_btn' class='hoverable center{% if nav_begin %} left_edge{% endif %} text_btn'
          {% if owner.has_thumb() %}
            ><img id='owner_thumb' src='{{owner.get_thumb(70)}}'
          {% endif %}
          ><div id='owner_name' class='text name'>by {{ owner.name|capitalize }}</div
        ></div
        {% set nav_begin = False %}
      {% endif %}
      ><div id='share_btn' class='hoverable center{% if nav_begin and exp %} left_edge{% endif %}{% if not exp %} rounded{% endif %}'
        ><div id='share_icon' class='icon{% if nav_begin %} left_edge{% endif %}'></div
        ><div class='text'>Share</div
      ></div
      {% if exp %}><div id='plus_btn' class='icon hoverable right_edge'></div{% endif %}
    ></div>

    {% if not user.logged_in %}
      <div id='login_menu' class='menu top'>
        <a href="{{facebook_authentication_url}}" onclick="_gaq.push(['_trackEvent', 'fb_connect', 'log_in_via_facebook']);">
          <img src='{{ 'skin/1/fb_sign_in.png'|asset_url }}' style='margin: 2px 0 2px -4px;'>
        </a>
        {% include 'page_parts/log_in.html' %}
      </div>
      <script>
        $(function() {
            var login_menu = hover_menu( '#login_btn', '#login_menu', {
                open: function() { $('#username').get(0).focus(); },
                close_delay: 1000,
                click_persist: '#login_menu',
                offset_y: 8,
                layout_x: 'right'
            } );
            {% if error %} login_menu.open(); {% endif %}
        });
      </script>
    {% endif %}

    {% if owner and not user_is_owner %}
      <div id='owner_menu' class='menu'>
        <a href='{{ owner.url }}'><div class='menu_item default'>Expressions</div></a>
        <div class='thumbs'>
          {% for expr in owner.expr_page(limit=5) %}
            <a href='{{ expr.url }}'><img src='{{ expr.thumb }}' class='thumb'></a>
          {% endfor %}
        </div>
        {#<div class='menu_item'>Profile</div>#}
        <div class='menu_item'>Follow {{ owner['name'] }}</div>
        {#<div class='menu_item'>Send message</div>#}
        <div class='bar'></div>
        <div class='menu_item'>Activity</div>
        <div id='owner_activity_feed'>
          {% for feed in owner.feed_profile(viewer=user, limit=6) %}
            {% include "partials/feed.html" %}
          {% endfor %}
        </div>
      </div>
      <script>hover_menu('#owner_btn', '#owner_menu', { offset_y: 8, layout_x: 'right' });</script>
    {% endif %}

    <div id='share_menu' class='menu'>
      {% set here = url | urlencode %}
      <div id="like_buttons">
        <div>
          <a class='facebook' onClick="logShare('facebook');" target="_blank" href='http://www.facebook.com/sharer.php?u={{ here }}'>
            <div class="like_button facebook">
              <img src='{{ 'skin/1/social/facebook.png'|asset_url }}' title='Share on Facebook'>
              <div class="count">&nbsp;{{ exp.analytic_count('facebook') | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
          <a class='twitter' onClick="logShare('twitter');" target="_blank" href='http://twitter.com/share?url={{ here }}'>
            <div class="like_button twitter">
              <img src='{{ 'skin/1/social/twitter.png'|asset_url }}' title='Share on Twitter'>
              <div class="count">&nbsp;{{ exp.analytic_count("twitter") | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
          <a class='tumblr' onClick="logShare('tumblr');" target="_blank">
            <div class="like_button tumblr">
              <img src='{{ 'skin/1/social/tumblr.png'|asset_url }}' title='Share on Tumblr'>
              <div class="count">&nbsp;{{ exp.analytic_count("tumblr") | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
          <a class='pinterest' onClick="logShare('pinterest');" target="_blank">
            <div class="like_button pinterest">
              <img src='{{ 'skin/1/social/pinterest.png'|asset_url }}' title='Share on Pinterest'>
              <div class="count">&nbsp;{{ exp.analytic_count("pinterest") | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
        </div>
        <div>
          <a class='stumble' onClick="logShare('stumble');" target="_blank" href='http://www.stumbleupon.com/submit?url={{ here }}&title={{ title | urlencode }}' title="Submit to Stumbleupon">
            <div class="like_button stumble">
              <img src='{{ 'skin/1/social/stumbleupon.png'|asset_url }}'/>
              <div class="count">&nbsp;{{ exp.analytic_count("stumble") | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
          <a href="https://plusone.google.com/_/+1/confirm?hl=en-US&url={{ here }}" title="Google+">
            <div class="like_button gplus">
              <img src="{{ 'skin/1/social/plus_one.png'|asset_url }}"/>
              <div class="count">&nbsp;{{ exp.analytic_count('gplus') | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
          <a href="https://plusone.google.com/_/+1/confirm?hl=en-US&url=ADD_YOUR_URL" >
            <div class="like_button linkedin">
              <img src="{{ 'skin/1/social/linkedin.png'|asset_url }}" title="Share to Linked In"/>
              <div class="count">&nbsp;{{ exp.analytic_count('linkedin') | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
          <a class='reddit' onClick="logShare('reddit');" target="_blank" href='http://www.reddit.com/submit?url={{ here }}' title="Submit to Reddit">
            <div class="like_button reddit">
              <img src='{{ 'skin/1/social/reddit.png'|asset_url }}'>
              <div class="count">&nbsp;{{ exp.analytic_count("reddit") | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
        </div>
      </div>

      <div class='bar'></div>
      <div class='menu_item'>Email</div>
      <div class='menu_item'>Embed</div>
    </div>
    <script>hover_menu('#share_btn', '#share_menu', { offset_y: 8 });</script>

    {% if exp %}
      <div id='plus_menu' class='plus_menu'>
        {% if user_is_owner %}
          <a href='{{ edit }}'><div class='nav_btn edit hoverable'>
            <span class='text'>Edit</span>
            <div class='icon'></div>
          </div></a>
          <div class='edit_spacer'></div>
        {% endif %}
        <div class='btn_box'>
          <div id='expr_btn' class='nav_btn views hoverable'>
            <div class='edge'></div>
            <div class='icon'></div>
            <div class='count'>{{ exp.views | large_number }}</div>
          </div>
        </div>
        <div class='btn_box'>
          <div class='nav_btn like hoverable'>
            <div class='edge'></div>
            <div class='icon'></div>
            <div class='count{{ ' zero' if not exp.star_count }}'>{{ exp.star_count | large_number }}</div>
          </div>
        </div>
        <div class='btn_box'>
          <div class='nav_btn broadcast hoverable'>
            <div class='edge'></div>
            <div class='icon'></div>
            <div class='count{{ ' zero' if not exp.broadcast_count }}'>{{ exp.broadcast_count | large_number }}</div>
          </div>
        </div>
        <div class='btn_box'>
          <div class='nav_btn comment hoverable'>
            <div class='edge'></div>
            <div class='icon'></div>
            <div class='count{{ ' zero' if not exp.comment_count }}'>{{ exp.comment_count | large_number }}</div>
          </div>
        </div>
        {% if user_is_owner %}
          <div class='nav_btn delete_btn hoverable plus_menu'>
            <span class='text'>Delete</span>
            <div class='icon'></div>
          </div>
        {% endif %}
      </div>

      <div id='expr_menu' class='menu'>
        
        {% for feed in exp.get_feed() %}
          {% include "partials/feed.html" %}
        {% endfor %}
      </div>

      <div id='broadcast_menu' class='menu'>
      </div>

      <div id='like_menu' class='menu'>
      </div>

      <script>
        //(function(){ 
            //var plus_menu = hover_menu('#plus_btn', '#plus_menu', { layout: false });
            hover_menu('#expr_btn', '#expr_menu', { layout: false });
        //})();
      </script>
    {% endif %}
  {% endif %}

  {% block body %}
  {% endblock body %}
  <div id="fb-root" style="position: fixed; top: 0; left: 0;"></div>
  <div id='content'>
    {% block content %}
      <div id="header">
        {% block header %}{% endblock %}
      </div>
      <div id="primary_content">
        <div id="left_column">
          {% block left_column %}{% endblock %}
        </div>
        <div id="right_column">
          {% block right_column %}{% endblock %}
        </div>
      </div>
    {% endblock content %}
  </div>

  {#{% if user.logged_in %}
    <img id='feedback_btn' style='position : fixed; bottom:0; right:0' src='{{ 'skin/1/feedback_btn.png'|asset_url }}' class='top hoverable tip_none' title='Send feedback'>
    <script>
      $('#feedback_btn').click(function() {
        new_window('{{ secure_server }}feedback?url=' + window.location, 470, 400);
      });
    </script>
  {% endif%}#}
  
  <div id='dialogs'>
    {% block dialogs %}
      {% include 'dialogs/password.html' %}

      {% if user.logged_in %}
          {% include 'dialogs/referral.html' %}
          {% include 'dialogs/facebook_connect.html' %}
          {% include 'dialogs/sent_invites_thanks.html' %}
          {% include 'dialogs/relogin.html' %}
      {% else %}
          {% include 'dialogs/sign_in_or_join.html' %}
          {% include 'dialogs/signup.html' %}
          {% include 'dialogs/password_recovery.html' %}
          {% include 'dialogs/must_login.html' %}
      {% endif %}

      {% if dialog_to_show.name == '#dia_fb_account_duplicate' %}
          {% include 'dialogs/fb_account_duplicate.html' %}
      {% endif %}

      {% if new_fb_connect %}
          {% include 'dialogs/fb_connect_landing.html' %}
      {% endif %}

      {% if exp and user_is_owner %}
        <div id='dia_delete' class='newdialog center'>
          <h3>Are you sure you want to delete this expression?</h3>
          <div class='btns'>
            <form method='POST' action='{{ secure_server }}'>
              <input type='hidden' name='action' value='expr_delete'>
              <input type='hidden' name='id' value='{{ exp.id }}'>
              <input type='submit' value='Yes' class='btn'> &nbsp;
              <input type='button' value='No' class='no_btn btn'>
            </form>
          </div>
        </div>
        <script>
          (function(){
            var dialog;
            $('.delete_btn').click(function(){ dialog = showDialog('#dia_delete'); });
            $('#dia_delete .no_btn').click(function(){ dialog.close() });
          })();
        </script>
      {% endif %}
    {% endblock dialogs %}
  </div>
{% endblock main %}
