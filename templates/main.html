{% extends "base.html" %}
{% from "macros/main.html" import listen_button, star_button, share_button, create_button, discussion_button, starrers_menu, context_to_string, person_thumb %} 

{% block head %}
{#<script>
  var fb_logged_in = false;
  window.fbAsyncInit = function() {
    FB.init({
      appId      : {{facebook_app_id|json}}, // App ID
      //channelUrl : '//WWW.YOUR_DOMAIN.COM/channel.html', // Channel File
      status     : true, // check login status
      cookie     : true, // enable cookies to allow the server to access the session
      xfbml      : true  // parse XFBML
    });
    FB.getLoginStatus(function(data){
        if (data.authResponse && data.authResponse.userID == fb_id) {
            fb_logged_in = true;
        }
    });
    // Additional initialization code here
  };

  // Load the SDK Asynchronously
  (function(d){
     var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement('script'); js.id = id; js.async = true;
     js.src = "//connect.facebook.net/en_US/all.js";
     ref.parentNode.insertBefore(js, ref);
   }(document));
</script>
#}
{% endblock head %}
{% block body_classes %}{{ super() }} main {% endblock body_classes%}

{% block main %}
  {% block body %}
  {% endblock body %}

  <div id='nav'
    ><a href='{{ server_url }}'><div id='logo' class='hoverable icon center black_active'></div></a
    {% if user.logged_in %}
      ><div id='user_btn' class='text_btn center hoverable black_active'
        ><img class='user_thumb {{ 'none' if not user.has_thumb }} icon center'
          src='{{ user.get_thumb(70) }}'
        ><div class='text_btn center text'>{{ user.name | capitalize }}</div
        ><div class='count rounded {{ ' none' if not user.notification_count }}'
          >{{ user.notification_count }}</div
      ></div
    {% else %}
        ><div id='sign_up_btn' class='text_btn center text hoverable black_active'
          ><span class='text'>Sign up</span></div
        ><div id='login_btn' class='text_btn center hoverable black_active'>Log In</div
    {% endif %}
    {% if not editing %}
      ><a id='create_btn' class='text_btn center hoverable black_active' href='{{ create }}'
        onclick='return require_login("create")'
        ><div class='icon center'></div
        ><div class='text_btn center text'>Create</div
      ></a
    {% endif %}
    ><a href='/random' title="View Random Expression" class='random_link'
      ><div class='random_btn icon center hoverable'></div></a
    ><form method='GET' action='/search' name='search_form'
      ><div class='center text'
        ><input type="text" id="search_box" placeholder="Search" name='q' value='{{ q.q|e }}'
        ><input type='image' src='{{ 'skin/nav/search_submit.png'|asset_url }}'
          class='hoverable submit' title='Submit search'
      ></div
    ></form
    ><div class='right'>{% block right_nav %}{% endblock %}</div
  ></div>

  {#
  <div id='user_nav_handle' class='menu_handle nav_handle'></div>
  <div id='user_nav'>
    <div id='user_nav_inner' class='horiz'
      ><a href='{{ server_url }}'><div id='logo' class='hoverable icon black_active'></div></a
      {% if user.logged_in %}
        ><div id='user_btn' class='hoverable center text_btn black_active'
          ><img class='user_thumb {{ 'none' if not user.has_thumb }}' src='{{ user.get_thumb(70) }}'
          ><div class='text name'>{{ user.name | capitalize }}<div class='count rounded
            {{ ' zero' if not user.notification_count }}'>{{ user.notification_count }}</div></div
        ></div
      {% else %}
          ><a href='{{ server_url }}'><div id='logotype' class='icon'></div></a
      {% endif %}
      {% if not editing %}
        ><div id='create_btn' class='center hoverable black_active'
          ><a href='/edit' onclick='return require_login("create")'
            ><div class='text'>Create</div
            ><div id='create_icon' class='icon'></div
          ></a></div
      {% endif %}
    ></div>
    {% if not user.logged_in %}
      <div id='call_to_action' onclick="require_login('call_to_action');">&nbsp;</div>
    {% endif %}
  </div>
  #}

  <div id='hive_menu' class='menu'
    {% if user.is_admin %}
      ><div class='menu_item' id="add_to_featured">
        <span class="true">+Re-add To Featured</span>
        <span class="false">+Add To Featured</span>
      </div
    {% endif %}
    {% if user.logged_in %}
      ><div class='menu_item feedback'>Send Us Feedback</div
      ><div onclick="Hive.logout_submit()" class='menu_item'>Log Out</div
      ><a href='{{ secure_server }}settings' class='menu_item'>Settings</a
      {% if user.has_facebook %}
        ><div class='menu_item' id='fb_invite_menu_item'>Invite Facebook Friends</div
        ><div class='menu_item' id='fb_listen_menu_item'>Find Facebook Friends</div
      {% endif %}
      ><div class='menu_item email_invites'>Email Invites</div
    {% endif %}
    ><a href='/thenewhive/about?q=%40thenewhive' class='menu_item'>About NewHive</a
    {% if user.logged_in %}
      ><a href='/home/people' class='menu_item'>People</a
      ><a href='/home/expressions' class='menu_item'>Expressions</a
      ><a href='/home/network' class='menu_item default'>My Network</a
    {% endif %}
  ></div>
  <form id='logout_form' action='{{ secure_server }}' method='POST'>
    <input name='action' value='logout' type='hidden'>
    <input type='hidden' name='url' value='{{ url }}'>
  </form>

  {% if not user.logged_in %}
    <div id='login_menu' class='menu top'>
      <a href="{{facebook_authentication_url}}" target="_top" onclick="_gaq.push(['_trackEvent', 'fb_connect', 'log_in_via_facebook']);">
        <img src='{{ 'skin/1/fb_sign_in.png'|asset_url }}' style='margin: 2px 0 2px -4px;'>
      </a>
      {% include 'page_parts/log_in.html' %}
    </div>
  {% endif %}

  {% if user.logged_in %}
    <div id='user_menu' class='menu feed_menu'>
      <div id='user_activity_feed' class='items'>
        {% for feed in user.feed_profile(viewer=user, limit=15)|reverse %}
          {% include "partials/feed.html" %}
        {% endfor %}
      </div>
      <a href='{{ user.url }}activity'><div class='menu_item'>Activity</div></a>
      <div class='bar'></div>
      <div class='thumbs'>
        {% for expr in user.expr_page(limit=5, viewer=user) -%}
          <a href='{{ expr.url }}?user={{ user.name }}'><img src='{{ expr.thumb }}' class='thumb'></a>
        {%- endfor %}
      </div>
      <a href='{{ user.url }}'><div class='menu_item default'>Expressions</div></a>
    </div>
  {% endif %}

  {% if not editing %}
    {% if expr or owner %}
      <div id='owner_menu' class='menu'>
        <div class='items'>
          {% if expr %}
            <b>Loading...</b>
          {% else %}
            {% for feed in owner.feed_profile(viewer=user, limit=15)|reverse %}
              {% include "partials/feed.html" %}
            {% endfor %}
          {% endif %}
        </div>
        {#<div class='menu_item message'>Send message <div class='icon'></div></div>#}
        <a href='{{ owner.url }}activity'><div class='menu_item'>Activity</div></a>
        <div class='bar'></div>
        <div class='menu_item listen off'>
          <div class='listen_text'>
            <span class='off'>Listen to</span>
            <span class='on' title="Stop listening">Listening to</span>
            <span class='owner_name'>{{ owner.name | capitalize }}</span>
          </div>
          <div class='icon'></div>
        </div>
        <div class='thumbs'>
          {% for expr in owner.expr_page(limit=5) -%}
            <a href='{{ expr.url }}'><img src='{{ expr.thumb }}' class='thumb'></a>
          {%- endfor %}
        </div>
        <a href='{{ owner.url }}' class='owner_url'><div class='menu_item default'>Expressions</div></a>
      </div>
    {% endif %}

    <div id='share_menu' class='menu'>
      {% if expr %}
        <div class='menu_item embed'>Embed
          <img src='{{ 'skin/nav/embed.png'|asset_url }}' class='icon'></div>
        <div class='menu_item message'>Email
          <img src='{{ 'skin/nav/message.png'|asset_url }}' class='icon'></div>
        <div class='bar'></div>
      {% endif %}
      {% set here = url | urlencode %}
      {% set large_thumb = (expr.thumb if expr else "") | urlencode %}
      <div id="like_buttons">
        <div>
          <a class='facebook' onClick="logShare('facebook');" target="_blank" href='http://www.facebook.com/sharer.php?u={{ here }}'>
            <div class="like_button facebook">
              <img src='{{ 'skin/1/social/facebook.png'|asset_url }}' title='Share on Facebook'>
              <div class="count">&nbsp;{{ exp.analytic_count('facebook') | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
          <a class='twitter' onClick="logShare('twitter');" target="_blank" href='http://twitter.com/share?url={{ here }}'>
            <div class="like_button twitter">
              <img src='{{ 'skin/1/social/twitter.png'|asset_url }}' title='Share on Twitter'>
              <div class="count">&nbsp;{{ exp.analytic_count("twitter") | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
          <a class='tumblr' onClick="logShare('tumblr');" target="_blank" href="http://www.tumblr.com/share?v=3&u={{here}}">
            <div class="like_button tumblr">
              <img src='{{ 'skin/1/social/tumblr.png'|asset_url }}' title='Share on Tumblr'>
              <div class="count">&nbsp;{{ exp.analytic_count("tumblr") | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
          <a class='pinterest' onClick="logShare('pinterest');" target="_blank" href="http://pinterest.com/pin/create/button/?url={{here}}&media={{large_thumb}}">
            <div class="like_button pinterest">
              <img src='{{ 'skin/1/social/pinterest.png'|asset_url }}' title='Share on Pinterest'>
              <div class="count">&nbsp;{{ exp.analytic_count("pinterest") | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
        </div>
        <div>
          <a class='stumble' onClick="logShare('stumble');" target="_blank" href='http://www.stumbleupon.com/submit?url={{ here }}&title={{ title | e | urlencode }}' title="Submit to Stumbleupon">
            <div class="like_button stumble">
              <img src='{{ 'skin/1/social/stumbleupon.png'|asset_url }}'/>
              <div class="count">&nbsp;{{ exp.analytic_count("stumble") | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
          <a class='gplus' onClick="logShare('gplus');" target="_blank" href="https://plusone.google.com/_/+1/confirm?hl=en-US&url={{ here }}" title="Google+">
            <div class="like_button gplus">
              <img src="{{ 'skin/1/social/plus_one.png'|asset_url }}"/>
              <div class="count">&nbsp;{{ exp.analytic_count('gplus') | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
          <a class='linkedin' onClick="logShare('linkedin');" target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url={{ here }}&title={{ title | e | urlencode }}" >
            <div class="like_button linkedin">
              <img src="{{ 'skin/1/social/linkedin.png'|asset_url }}" title="Share to Linked In"/>
              <div class="count">&nbsp;{{ exp.analytic_count('linkedin') | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
          <a class='reddit' onClick="logShare('reddit');" target="_blank" href='http://www.reddit.com/submit?url={{ here }}' title="Submit to Reddit">
            <div class="like_button reddit">
              <img src='{{ 'skin/1/social/reddit.png'|asset_url }}'>
              <div class="count">&nbsp;{{ exp.analytic_count("reddit") | no_zero | large_number if exp and exp.id else zero_count_string }}&nbsp;</div>
            </div>
          </a>
        </div>
      </div>
    </div>
  {% endif %}

  <div id="fb-root" style="position: fixed; top: 0; left: 0;"></div>
  <div id='content'>
    {% block content %}
      <div id="header">
        {% block header %}{% endblock %}
      </div>
      <div id="primary_content">
        <div id="left_column">
          {% block left_column %}{% endblock %}
        </div>
        <div id="right_column">
          {% block right_column %}{% endblock %}
        </div>
      </div>
    {% endblock content %}
  </div>

{% endblock main %}
