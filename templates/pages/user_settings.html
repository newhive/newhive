{% extends "main.html" %}

{% block content %}
 <br><br>

 <div style='margin : 0 auto; width : 950px'>
  <div style='float : left; display:inline-block;text-align:left'>
 
  <form id='form' method='POST'>
   <input type='hidden' name='action' value='user_create'>
 
   <b>Username</b><br>
   <input id='name' type='text' name='name' value='{{f.name}}'><br>
   <div class="form_validation_info" id="name_availability" style="display:none">Sorry, that name isn't available</div>
   <br>
 
   <b>Password</b><br>
   <input id='p1' type='password' name='password' value='{{f.secret}}'><br>
   <b>Repeat</b><br>
   <input id='p2' type='password' value='{{f.secret}}'><br>
   <br>
   
   <b>Email</b><br>
   <input type='text' name='email' value='{{f.email}}'><br>
   <br>
   
   <b>Full Name</b><br>
   <input type='text' name='fullname' value='{{f.fullname}}'><br>
   <br>
 
   <input type='checkbox' id='tos' name='tos'><label for='tos'><b> I agree to the Terms of Service</b></label><br>
   <br>
 
   <input class='medbold' type='submit' value='Create Account!'>
  
  </form>
  <script>
    $(document).ready(function(){
      $('#name').blur(function(){
        user_check($(this).val());
      });
    });
    function user_check(user_name){
      var n = $('#name').val().trim();
      $('#name').val(n);
      if( $('#name').val().length < 3 ) {
          $('#name_availability').html("Sorry, that username isn't available").show().removeClass('valid').addClass('invalid');
          return false;
      }
      if( ! n.match(/^[a-z][a-z0-9]{2,}$/i) ) {
          $('#name_availability').html("Username must be only letters and numbers, and start with a letter (no spaces or punctuation, thank you).").show().removeClass('valid').addClass('invalid');
          return false;
      }
 
      $.ajax({
        type: "POST",
        dataType: 'json',
        data: {action: "user_check", name: user_name},
        success: function(data){
          if (data) {
            $('#name_availability').html("Your website will be:<br><code>" + user_name + ".{{ server_name }}</code>").show().addClass('valid').removeClass('invalid');
          } else {
            $('#name_availability').html("Sorry, that username isn't available").show().removeClass('valid').addClass('invalid');
          }
        },
        error: function(){$('#name_unavailable').html("Sorry, that username isn't available").show().removeClass('valid').addClass('invalid');}
      });
    }
 function validate() {
     var n = $('#name').val().trim();
     $('#name').val(n);
     if( $('#name').val().length < 3 ) {
         alert('Please enter username of at least 3 letters, thank you.');
         return false;
     }
     if( ! n.match(/^[a-z][a-z0-9]{2,}$/i) ) {
         alert('Username must be only letters and numbers, and start with a letter (no spaces or punctuation, thank you).');
         return false;
     }
     if( ! $('#name_availability').hasClass('valid') ) {
         alert("Your username isn't avaialable, please try again.");
         return false;
     }
 
     if( $('#p1').val().length < 4 ) {
         alert('Password too short');
         return false;
     }
     if( $('#p1').val() != $('#p2').val() ) {
         alert('Passwords do not match');
         return false;
     }
     if( ! $('[name=email]').val().match(/^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+[a-zA-Z0-9]{2,4}$/) ) {
         alert('Please enter valid email address.');
         return false;
     }
     if( ! $('[name=tos]').is(':checked') ) {
         alert('Please agree to Terms of Service.');
         return false;
     }
 }
 $('#form').submit(validate);
  </script>
  
  </div>
  <div style='float : right; margin-left : 100px'>
   <b>Terms of Service</b><br>
   <iframe src='/lib/doc/tos.html' style='height:400px;width:500px;' class='border'></iframe>
  </div>
 </div>

{% endblock %}
