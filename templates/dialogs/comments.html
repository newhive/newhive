{% extends "base.html" %}
{% block main %}
<div id='dia_comments'>
  <div class='header'>
    <img class="icon" src='/lib/skin/1/discussion.png' title='Discussion Icon' />
    <h3 class="title">Discussion<span class='comments_count'> ({{ expr.comment_count }})</span></h3>
    <form>
      <input type="hidden" name="action" value="add_comment" />
      <input type="hidden" name="expression" value="{{exp.id}}" />
      <textarea name="comment"></textarea>
      <input type="submit" class="btn black rounded" value="Enter" onclick="submitComment(); return false;"/>
    </form>
  </div>
  <div id="comments">
    {% for comment in expr.comments %}
    <div class='comment'>
      {% if comment.thumb %}
      <img class='comment_thumb' src='{{comment.thumb}}' title='{{comment.author}}'/>
      {% else %}
      <div class='comment_thumb'></div>
      {% endif %}
      <div class="comment_content">
        <p class='text'>{{comment.text|e}}</p>
        <h3 class='author'>{{comment.author|e}}</h3>
        <h3 class='age'>{{comment.created|friendly_date}}</h3>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
{% block head %}
<script>
  var max_height = {{ max_height if max_height else 450 }};
  var submitComment = function(){
    asyncSubmit($('#dia_comments form'), function(data){
      window.location = window.location;
    });
  };
  var comment_count = {{expr.comment_count}};
  $(function(){
      var header_height = $('.header').height();
      var max_comments_height = max_height - header_height;
      var height = 150 * comment_count;
      if (height > max_comments_height) height = max_comments_height;
      $('#comments').css('height', height);
      var message = $.param({'height': height + header_height});
      parent.postMessage(message, '*');
  });
</script>
{% endblock %}
